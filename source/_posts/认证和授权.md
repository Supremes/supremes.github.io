---
title: 认证和授权
date: 2025-11-27 20:39:20
tags:
    - Authentication
    - Authorization
categories:
    - 学习笔记
description:
cover: /imgs/认证和授权封面图.png
---

在认证（Authentication）和授权（Authorization）过程中，协议和Token是确保安全访问资源的基石。以下从协议和Token两个维度进行系统性阐述：

---

### **一、认证授权协议**
#### **1. OAuth 2.0**
+ **用途**：专注于**授权**（资源访问权限的委派），而非直接处理用户身份认证。
+ **核心角色**：
    - 客户端（Client）：请求访问资源的应用。
    - 资源所有者（Resource Owner）：用户。
    - 授权服务器（Authorization Server）：颁发Token。
    - 资源服务器（Resource Server）：存储受保护资源。
+ **授权模式**：
    - **授权码模式（Authorization Code）**：适用于Web应用（服务端安全）。
    - **隐式模式（Implicit）**：适用于SPA或原生App（客户端不安全）。
    - **密码模式（Resource Owner Password Credentials）**：用户直接提供密码（仅信任客户端时使用）。
    - **客户端凭证模式（Client Credentials）**：服务端间通信（无用户参与）。
+ **场景**：第三方应用访问用户资源（如微信登录后获取用户数据）。

#### **2. OpenID Connect (OIDC)**
+ **用途**：在OAuth 2.0基础上扩展，解决**身份认证**问题。
+ **核心组件**：
    - **ID Token**：JWT格式，包含用户身份信息（如姓名、邮箱）。
    - **UserInfo端点**：通过Access Token获取用户详细信息。
+ **流程**：在OAuth流程中返回ID Token，明确用户身份。
+ **场景**：单点登录（SSO），如使用Google账号登录第三方应用。

#### **3. SAML 2.0**
+ **用途**：企业级**认证与授权**，基于XML实现跨域单点登录。
+ **核心组件**：
    - **断言（Assertion）**：包含用户身份和权限信息（类似Token）。
    - **身份提供者（IdP）**：认证用户并生成SAML断言。
    - **服务提供者（SP）**：依赖IdP的断言授权访问。
+ **流程**：用户访问SP → 重定向到IdP认证 → 返回SAML断言 → SP验证断言。
+ **场景**：企业内网SSO（如使用ADFS实现Office 365登录）。

#### **4. LDAP（Lightweight Directory Access Protocol）**
+ **用途**：访问和维护**目录服务**（如用户、组织信息查询）。
+ **常见实现**：Microsoft Active Directory（AD）、OpenLDAP。
+ **场景**：企业内部用户认证和权限管理（如VPN登录验证）。

#### **5. Kerberos**
+ **用途**：基于票据的**网络认证协议**，防止中间人攻击。
+ **核心组件**：
    - **TGT（Ticket-Granting Ticket）**：用户首次认证后获取的长期票据。
    - **服务票据（Service Ticket）**：访问具体服务时使用。
+ **场景**：Windows域环境中的资源访问认证。

---

### **二、认证授权中的Token类型**
#### **1. Access Token**
+ **用途**：客户端访问资源服务器的凭证。
+ **格式**：
    - **不透明Token**：随机字符串，需向授权服务器验证（如OAuth 2.0默认）。
    - **JWT（自包含Token）**：包含用户信息和权限，资源服务器可本地验证。
+ **生命周期**：短期有效（如1小时），需配合Refresh Token续期。

#### **2. Refresh Token**
+ **用途**：在Access Token过期后，获取新的Access Token。
+ **特点**：
    - 长期有效（如7天），但可撤销。
    - 仅存储于客户端和授权服务器，不暴露给资源服务器。
+ **安全要求**：必须通过HTTPS传输，避免泄露。

#### **3. ID Token（OpenID Connect）**
+ **格式**：JWT，包含用户身份信息（如`sub`用户ID、`email`）。
+ **签名**：由授权服务器签名，防止篡改。
+ **示例**：

```json
{
  "iss": "https://accounts.google.com",
  "sub": "1234567890",
  "email": "user@example.com",
  "exp": 1620000000
}
```

#### **4. JWT（JSON Web Token）**
+ **结构**：
    - **Header**：算法（如HS256、RS256）和Token类型。
    - **Payload**：声明（Claims），如用户ID、过期时间。
    - **Signature**：防止数据篡改（Header+Payload+密钥生成）。
+ **用途**：
    - Access Token（自包含，无需查库验证）。
    - ID Token（传递用户信息）。
+ **风险**：若密钥泄露或弱算法（如HS256密钥简单），可能导致伪造。

#### **5. Session Token（会话Token）**
+ **用途**：服务端维护用户会话状态（如PHP的PHPSESSID）。
+ **存储**：
    - 服务端：Session数据存储在内存/数据库（如Redis）。
    - 客户端：通过Cookie或LocalStorage传递Session ID。
+ **与JWT对比**：
    - **有状态 vs 无状态**：Session需服务端存储状态，JWT自包含。
    - **扩展性**：JWT更适合分布式系统，Session需共享存储。

#### **6. SAML断言**
+ **格式**：XML结构，包含用户属性和授权决策。
+ **类型**：
    - **认证断言**：用户已通过IdP认证。
    - **属性断言**：用户属性（如角色、部门）。
    - **授权决策断言**：用户是否有权访问资源。

---

### **三、协议与Token的配合使用**
#### **1. OAuth 2.0 + OpenID Connect**
+ **流程**：
    1. 用户通过OAuth授权客户端访问资源。
    2. 授权服务器返回Access Token（访问资源）和ID Token（认证身份）。
    3. 客户端通过UserInfo端点获取详细信息。
+ **优势**：同时解决授权（OAuth）和认证（OIDC）需求。

#### **2. SAML + LDAP**
+ **流程**：
    1. 用户登录企业IdP（如AD），生成SAML断言。
    2. SP（如SaaS应用）验证断言，授权访问。
    3. 用户属性通过LDAP从目录服务获取。
+ **场景**：企业应用集成AD实现SSO。

---

### **四、安全注意事项**
1. **Token传输安全**：
    - 必须使用HTTPS，防止中间人窃听。
    - 避免URL传递Token（可能被日志记录）。
2. **Token存储安全**：
    - 浏览器端：使用HttpOnly Cookie防止XSS攻击。
    - 移动端：安全存储（如Android Keystore、iOS Keychain）。
3. **密钥管理**：
    - JWT签名密钥需定期轮换。
    - 避免硬编码密钥，使用密钥管理服务（如AWS KMS）。
4. **防止重放攻击**：
    - Token设置短期有效期。
    - 使用`nonce`参数（OIDC）或时间戳校验。

---

### **五、总结与选型建议**
| **场景** | **推荐协议** | **Token类型** |
| --- | --- | --- |
| 第三方应用授权（如社交登录） | OAuth 2.0 + OIDC | Access Token + ID Token |
| 企业SSO（内部系统集成） | SAML 2.0 | SAML断言 |
| 移动端/SPA无状态认证 | OIDC + JWT | JWT（自包含Access Token） |
| 服务间通信 | OAuth 2.0客户端凭证模式 | 不透明Token或JWT |


**最佳实践**：

+ 优先使用OAuth 2.1（合并OAuth 2.0安全增强）。
+ 对公共客户端（如SPA）启用PKCE（Proof Key for Code Exchange）。
+ 定期审计Token权限，遵循最小权限原则。


